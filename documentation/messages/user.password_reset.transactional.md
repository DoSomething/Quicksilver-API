# User password reset transactional message

User password reset event to trigger functionality within the Quicksilver system.

----

#### Current Configuration
Accessed by connecting to RabbitMQ server and sending message in the following format.

**Routing key**

`user.password_reset.transactional`

**Exchanges**
- `transactionalExchange`

**Consumers**

| Consumer                                                                                 | Binding key           |
| ---------------------------------------------------------------------------------------- | ----------------------|
| [mbp-externalApplications-dashboard](../consumers/mbp-externalApplications-dashboard.md) |  `*.*.transactional`  |
| [mbc-logging-gateway](../consumers/mbc-logging-gateway.md)                               |  `*.*.transactional`  |
| [mbc-transactional-email](../consumers/mbc-transactional-email.md)                       |  `*.*.transactional`  |

#### Current Message Payload

```js
{

  /* Required. Always must be `user_password`. */
  activity: String,

  /* Required. */
  email: String,

  /* Required. Phoenix user id. */
  uid: Number,

  /* Required, Example: `US`. */
  user_country: String,

  /* Required, Example: `en`. */
  user_language: String,

  /* Optional. Default is generated base on `user_country` field. Example: `mb-user-password-US`. */
  email_template: String,

  /* Required. Unix timestamp. Example: `1458067430`. */
  activity_timestamp: Number,

  /* Required. Example: `US`. */
  application_id: String,

  /* Required. An array of string to tag the message with. Example: `drupal_user_password`. */
  email_tags: Array,

  /* Required. An array of variables to inject into Mandrill template. */
  /* Required keys: `MEMBER_COUNT`, `FNAME`, 'RESET_LINK' */
  merge_vars: Array,

}
```

----

#### Suggested API

**Endpoint**

`POST /user/password`

**Body Parameters**

```js
{

  /* Required: user_id or email or mobile. Northstar user ID. Example: `555b9225bffebc31068b4567`. */
  user_id: String,

  /* Required: user_id or email or mobile. */
  email: String,

  /* Required: user_id or email or mobile. */
  mobile: Integer,

  /* Optional. Client application identifier. Example: `Phoenix`. */
  application_id: String,

  /* Optional. The default is generated base on `user_country` value gathered from user settings found for `email` or `user_id`. Example: `mb-user-password-US`. Defining this value allows for specification of an alternative template. */
  email_template: String,

}
```

Changes:

- :x: `activity`: always `user_password` for this message type
- :x: `merge_var: MEMBER_COUNT` retrieved from Phoenix: see [API](https://github.com/DoSomething/phoenix/wiki/API#get-member-count)
- :x: `merge_var: FNAME` value from Northstar
- :x: `merge_var: RESET_LINK` removed. The resetURL is generated by the consumer that responds to this message
- :x: `activity_timestamp` set in Quicksilver API
- :x: `user_language` value from Northstar
- :heavy_exclamation_mark: `email_tag` will be determined from `application_id`
- :heavy_exclamation_mark: `application_id` new optional field to determine client app
- :heavy_exclamation_mark: `email_template` should be determined from `user_country` but can be defined to use specific template.
- :heavy_exclamation_mark: `user_id` Phoenix user id is replaced with [Northstar](https://github.com/DoSomething/northstar/blob/dev/documentation/endpoints/users.md#retrieve-a-user) user id.
